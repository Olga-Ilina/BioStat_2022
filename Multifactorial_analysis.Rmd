---
title: "Multifactorial_analysis"
author: "Olga"
date: "2022-12-22"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: true
    theme: flatly
    keep_md: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r libraries, include=FALSE}
library("mvtnorm")
library("base")
library("dplyr")
library("olsrr")
library ("magrittr")
library ("plyr")
library("glmnet")
```

1. Известно, что креатинин k и мочевина m являются сильно коррелированными величинами, распределения которых близки к нормальным. При этом μk = 88.5, σk = 13.25, μm = 5.4, σm = 1.45, а коэффициент корреляции ρ(k, m) = 0.6.

Смоделируйте выборку S, содержащий информацию о 100 пациентах, у которых замерили эти два показателя. 

Предположим, что вы хотите построить линейную модель, связывающую их. 
(Воспользуйтесь пакетом mvtnorm чтобы смоделировать соответствующее многомерное нормальное распределение.)



```{r}
# Standard deviations and correlation
sig_k <- 13.25
sig_m <- 1.45
rho_km <- 0.6

# Covariance between k and m
sig_km <- rho_km * sig_k * sig_m

# Covariance matrix
Sigma_km <- matrix(c(sig_k ^ 2, sig_km, sig_km, sig_m ^ 2), nrow = 2, ncol = 2)


#means
mu_k <- 88.5
mu_m <- 5.4

# simulate 100 observations
set.seed(123) # for reproducibility
km_vals <- rmvnorm(100, mean = c(mu_k, mu_m), sigma = Sigma_km) # multivariate normal distribution

# Have a look at the first observations
head(km_vals)

```
```{r}
# convert matrix to data frame
km_vals <- as.data.frame(km_vals)

```

```{r}
# rename columns
km_vals <- km_vals %>% 
  rename(
    Kreatinine = V1,
    Urea = V2
    )
```


(a) (1 балл) Как выглядит модель линейной регрессии креатинина k на мочевину m? Воспользуйтесь функцией lm, чтобы оценить параметры в этой модели. 
Как полученные оценки связаны с выборочными характеристиками (средним, дисперсией, корреляцией) выборки S?


```{r}
lm_km <- lm(Kreatinine~Urea, data = km_vals) #Create the linear regression
summary(lm_km) #Review the results
```
Модель линейной регрессии креатинина на мочевину выглядит следующим образом:
Kreatinine = 65.91*Urea + 4.21


(b) (1 балл) Проверьте гипотезу о нормальном распределении остатков в вашей модели.
Распределение остатков в модели выглядит следующим образом:
Residuals:
     Min       1Q   Median       3Q      Max 
-26.5217  -6.7218   0.9362   7.0692  26.0898 

Т.о. сумма остатков примерно равна нулю.

```{r}
# residual normality test
ols_plot_resid_qq(lm_km) # residual QQ plot
ols_test_normality(lm_km) # residual normality test
ols_plot_resid_hist(lm_km) # residual histogram
```
Тест на нормальность реального распределения остатков показывает отсутствие статистически значимых отличий с предполагаемым распределением остатков. Т.о. остатки в данной модели распределены нормально.

Коэффициент детерминации R² данной модели составил 0.2119, adjusted  R² 0.2038 
20.38% дисперсии в популяции объясняется уравнением линейной регрессии.

(c) (1 балл) Добавим в модель еще один признак W, никак не связанный с k и m. Смоделируйте одномерную выборку (с произвольным распределением), и, считая ее одним из признаков в выборке S, добавьте этот признак в вашу модель линейной регрессии. Как изменился коэффициент детерминации в новой модели? Как изменился модифицированный коэффициент детерминации?

```{r}
# sample with random distribution
Kalium <- round (runif(100, 3, 6), 2) 

# convert matrix to data frame
Kalium <- as.data.frame(Kalium)

```


```{r}
df <-cbind(km_vals, Kalium)
```



```{r}
lm_km2 = lm(Kreatinine~Urea + Kalium, data = df) #Create a linear regression with two variables
summary(lm_km2) #Review the results
```
Модель линейной регрессии описывается формулой:
Kreatinine = 68,06 + Urea * 4.23 - Kalium * 0.5

Однако уровень значимость p для Kalium превышает 0.05 и составляет 0.678. 
Т.о. в 67.8% случаев данный предиктор не является статистически значимым в данной модели.


```{r}
# residual normality test
ols_plot_resid_qq(lm_km2) # residual QQ plot
ols_test_normality(lm_km2) # residual normality test
ols_plot_resid_hist(lm_km2) # residual histogram
```
Распределение остатков не отличается от нормального.

Коэффициент детерминации R² данной модели составил 0.2133, adjusted R² 0.197. Это значит, что 19.7% дисперсии в популяции объясняется уравнением линейной регрессии. По сравнению с предыдущей моделью коэффициент детерминации уменьшился, но не значимо.

=======

2. (2 балла) Смоделируйте такую выборку объема 50 c 6 признаками, чтобы в модели линейной регрессии первого признака на остальные 5 каждый из коэффициентов регрессии в отдельности не значимо отличался от 0, но все параметры в совокупности — значимо. Воспользуйтесь пакетом glmnet, чтобы построить для такой модели lasso-оценку c параметром r = 0.2. Как изменились при этом оценки коэффициентов линейной регрессии? Придумайте из своей практики набор сильно зависимых показателей, которые могут быть связаны регрессионным соотношением.

```{r}

```



======
3. (2 балла) У пациента, попавшего в реанимацию с риском сепсиса, измеряют уровень нейтрофилов (Neu) и лимфоцитов (Ly). При определенном заболевании уровень лимфоцитов является нормальной случайной величиной с распределением N(20; 5), а уровень нейтрофилов — N(80; 5). 
Пусть при нейтрофильно-лимфоцитарном соотношении NLR < 3 угроза сепсиса отсутствует, NLR > 9 - сепсис неизбежен, при остальных значениях сепсис возникает с вероятностью p = (NLR−3) / 6.

Смоделируйте трёхмерную выборку S объема 201, состоящую из наблюдений за (Neu, Ly, Sepsis). Воспользуйтесь пакетом glmnet и функцией glm, чтобы построить модель логистической регрессии признака Sepsis на Neu и Ly. Какая вероятность для случайной величины Sepsis быть равной 1, если Neu = 90, а Ly = 15? Какую вероятность предсказывает ваша модель (воспользуйтесь функцией predict)?

```{r}

```

